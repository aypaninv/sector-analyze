<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Portfolio Technical Report</title>

<style>
body {
  margin: 0;
  font-family: "Courier New", monospace;
  font-size: 13px;
}

.container {
  display: flex;
  height: 100vh;
}

/* Sidebar */
.sidebar {
  width: 240px;
  background: #1e1e1e;
  color: white;
  padding: 10px;
  overflow-y: auto;
}

.sidebar h3 {
  margin-top: 10px;
  text-align: center;
  border-bottom: 1px solid #444;
  padding-bottom: 5px;
}

.tab {
  padding: 8px;
  margin: 4px 0;
  cursor: pointer;
  background: #333;
  border-radius: 4px;
}

.tab:hover { background: #555; }
.tab.active { background: #007acc; }

/* Content */
.content {
  flex: 1;
  padding: 10px;
  overflow-x: auto;
}

table {
  border-collapse: collapse;
  width: 100%;
  min-width: 900px;
}

th, td {
  border: 1px solid #ccc;
  padding: 6px;
}

th {
  background: #f0f0f0;
  position: sticky;
  top: 0;
  cursor: pointer;
  white-space: nowrap;
}

td.text { text-align: left; }
td.num  { text-align: right; }

.green { background: #c8f7c5; }
.red   { background: #f7c5c5; }

/* Mobile */
@media (max-width: 768px) {
  .sidebar { width: 180px; }
  body { font-size: 12px; }
}
</style>
</head>

<body>

<div class="container">
  <div class="sidebar">
    <h3>Filters</h3>
    <div id="tabs"></div>
  </div>

  <div class="content">
    <table id="dataTable"></table>
  </div>
</div>

<script>
const CSV_FILE = "portfolio_report.csv";
let rawData = [];
let currentData = [];
let sortState = {};

function parseCSV(text) {
  const lines = text.trim().split("\n");
  const headers = lines[0].split(",");
  return lines.slice(1).map(row => {
    const values = row.split(",");
    let obj = {};
    headers.forEach((h, i) => obj[h] = values[i] ?? "");
    return obj;
  });
}

/* ---------- Tabs ---------- */
function createTabs(data) {
  const tabs = document.getElementById("tabs");
  tabs.innerHTML = "";

  createTab("EXIT", d =>
    d.StopLoss && parseFloat(d.Close) < parseFloat(d.StopLoss)
  );

  createGroupTabs("Folio", "Folio", data);
  createGroupTabs("SectorWise", "Sector", data);
  createGroupTabs("MarketCapWise", "MarketCap", data);
}

function createTab(label, filterFn) {
  const div = document.createElement("div");
  div.className = "tab";
  div.innerText = label;
  div.onclick = () => {
    setActive(div);
    currentData = rawData.filter(filterFn);
    renderTable(currentData);
  };
  tabs.appendChild(div);
}

function createGroupTabs(title, field, data) {
  const h = document.createElement("h3");
  h.innerText = title;
  tabs.appendChild(h);

  [...new Set(data.map(d => d[field]).filter(Boolean))].sort()
    .forEach(val => {
      const div = document.createElement("div");
      div.className = "tab";
      div.innerText = val;
      div.onclick = () => {
        setActive(div);
        currentData = rawData.filter(d => d[field] === val);
        renderTable(currentData);
      };
      tabs.appendChild(div);
    });
}

function setActive(tab) {
  document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
  tab.classList.add("active");
}

/* ---------- Table ---------- */
function renderTable(data) {
  const table = document.getElementById("dataTable");
  table.innerHTML = "";
  if (!data.length) return;

  const headers = Object.keys(data[0]);

  const trHead = document.createElement("tr");
  headers.forEach(h => {
    const th = document.createElement("th");
    th.innerText = h;
    th.onclick = () => sortBy(h);
    trHead.appendChild(th);
  });
  table.appendChild(trHead);

  data.forEach(row => {
    const tr = document.createElement("tr");

    headers.forEach(h => {
      const td = document.createElement("td");
      const val = row[h];
      td.innerText = val;

      const num = !isNaN(val) && val !== "";
      td.className = num ? "num" : "text";

      if (h.includes("MACD") && val !== "")
        td.classList.add(parseFloat(val) >= 0 ? "green" : "red");

      if (h.includes("RSI") && val !== "")
        td.classList.add(parseFloat(val) >= 53 ? "green" : "red");

      tr.appendChild(td);
    });
    table.appendChild(tr);
  });
}

/* ---------- Sorting ---------- */
function sortBy(col) {
  const asc = !sortState[col];
  sortState = {};
  sortState[col] = asc;

  currentData.sort((a, b) => {
    const x = a[col], y = b[col];
    const nx = parseFloat(x), ny = parseFloat(y);

    if (!isNaN(nx) && !isNaN(ny))
      return asc ? nx - ny : ny - nx;

    return asc
      ? String(x).localeCompare(String(y))
      : String(y).localeCompare(String(x));
  });

  renderTable(currentData);
}

/* ---------- Load ---------- */
fetch(CSV_FILE)
  .then(r => r.text())
  .then(t => {
    rawData = parseCSV(t);
    currentData = rawData;
    createTabs(rawData);
  });
</script>

</body>
</html>
