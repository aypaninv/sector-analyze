<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Portfolio Technical Report</title>

<style>
body {
  margin: 0;
  font-family: "Courier New", monospace;
  font-size: 13px;
}

/* ---------- Top Tabs ---------- */
.topbar {
  display: flex;
  background: #1e1e1e;
  color: white;
  padding: 8px;
  gap: 10px;
}

.top-tab {
  padding: 8px 14px;
  cursor: pointer;
  background: #333;
  border-radius: 4px;
}

.top-tab.active {
  background: #007acc;
}

/* ---------- Layout ---------- */
.container {
  display: flex;
  height: calc(100vh - 48px);
}

.sidebar {
  width: 220px;
  background: #2a2a2a;
  color: white;
  padding: 10px;
  overflow-y: auto;
}

.sidebar.hidden {
  display: none;
}

.sidebar .tab {
  padding: 8px;
  margin: 4px 0;
  background: #444;
  cursor: pointer;
  border-radius: 4px;
}

.sidebar .tab.active {
  background: #007acc;
}

.content {
  flex: 1;
  padding: 8px;
  overflow-y: auto;
}

/* ---------- Table ---------- */
table {
  border-collapse: collapse;
  width: 100%;
  table-layout: fixed;
}

th, td {
  border: 1px solid #ccc;
  padding: 6px;
  word-wrap: break-word;
  white-space: normal;
}

th {
  background: #f0f0f0;
  position: sticky;
  top: 0;
  cursor: pointer;
}

td.text { text-align: left; }
td.num  { text-align: right; }

.green { background: #c8f7c5; }
.red   { background: #f7c5c5; }

.group-header {
  background: #ddd;
  font-weight: bold;
  text-align: left;
}

@media (max-width: 768px) {
  body { font-size: 12px; }
  .sidebar { width: 160px; }
}
</style>
</head>

<body>

<!-- ---------- Top Tabs ---------- -->
<div class="topbar">
  <div class="top-tab active" onclick="activateTopTab('Folio')">Folio</div>
  <div class="top-tab" onclick="activateTopTab('EXIT')">EXIT</div>
  <div class="top-tab" onclick="activateTopTab('SectorWise')">SectorWise</div>
  <div class="top-tab" onclick="activateTopTab('MarketCapWise')">MarketCapWise</div>
</div>

<div class="container">
  <div class="sidebar" id="sidebar"></div>
  <div class="content">
    <table id="dataTable"></table>
  </div>
</div>

<script>
const CSV_FILE = "portfolio_report.csv";
let rawData = [];
let currentData = [];
let sortState = {};
let currentMode = "Folio";

/* ---------- CSV ---------- */
function parseCSV(text) {
  const lines = text.trim().split("\n");
  const headers = lines[0].split(",");
  return lines.slice(1).map(r => {
    const v = r.split(",");
    let o = {};
    headers.forEach((h, i) => o[h] = v[i] ?? "");
    return o;
  });
}

/* ---------- Top Tabs ---------- */
function activateTopTab(mode) {
  currentMode = mode;
  document.querySelectorAll(".top-tab").forEach(t => t.classList.remove("active"));
  [...document.querySelectorAll(".top-tab")]
    .find(t => t.innerText === mode).classList.add("active");

  const sidebar = document.getElementById("sidebar");

  if (mode === "Folio") {
    sidebar.classList.remove("hidden");
    buildFolioSidebar();
  } else {
    sidebar.classList.add("hidden");
  }

  if (mode === "EXIT") {
    currentData = rawData.filter(d =>
      d.StopLoss && parseFloat(d.Close) < parseFloat(d.StopLoss)
    );
    renderTable(currentData);
  }

  if (mode === "SectorWise") renderGrouped("Sector");
  if (mode === "MarketCapWise") renderGrouped("MarketCap");
}

/* ---------- Folio Sidebar (UNCHANGED LOGIC) ---------- */
function buildFolioSidebar() {
  const sb = document.getElementById("sidebar");
  sb.innerHTML = "<h3>Folio</h3>";

  [...new Set(rawData.map(d => d.Folio).filter(Boolean))].sort()
    .forEach(f => {
      const div = document.createElement("div");
      div.className = "tab";
      div.innerText = f;
      div.onclick = () => {
        document.querySelectorAll(".sidebar .tab").forEach(t => t.classList.remove("active"));
        div.classList.add("active");
        currentData = rawData.filter(d => d.Folio === f);
        renderTable(currentData);
      };
      sb.appendChild(div);
    });
}

/* ---------- Grouped Views ---------- */
function renderGrouped(field) {
  const table = document.getElementById("dataTable");
  table.innerHTML = "";

  const groups = {};
  rawData.forEach(r => {
    const key = r[field] || "Others";
    groups[key] = groups[key] || [];
    groups[key].push(r);
  });

  Object.keys(groups).sort().forEach(group => {
    const tr = document.createElement("tr");
    const td = document.createElement("td");
    td.colSpan = Object.keys(rawData[0]).length;
    td.className = "group-header";
    td.innerText = `${field}: ${group}`;
    tr.appendChild(td);
    table.appendChild(tr);

    renderTable(groups[group], true);
  });
}

/* ---------- Table ---------- */
function renderTable(data, append=false) {
  const table = document.getElementById("dataTable");
  if (!append) table.innerHTML = "";
  if (!data.length) return;

  const headers = Object.keys(data[0]);

  if (!append) {
    const trh = document.createElement("tr");
    headers.forEach(h => {
      const th = document.createElement("th");
      th.innerText = h;
      th.onclick = () => sortBy(h);
      trh.appendChild(th);
    });
    table.appendChild(trh);
  }

  data.forEach(r => {
    const tr = document.createElement("tr");
    headers.forEach(h => {
      const td = document.createElement("td");
      const v = r[h];
      td.innerText = v;
      td.className = (!isNaN(v) && v !== "") ? "num" : "text";

      if (h.includes("MACD") && v !== "")
        td.classList.add(parseFloat(v) >= 0 ? "green" : "red");
      if (h.includes("RSI") && v !== "")
        td.classList.add(parseFloat(v) >= 53 ? "green" : "red");

      tr.appendChild(td);
    });
    table.appendChild(tr);
  });
}

/* ---------- Sorting ---------- */
function sortBy(col) {
  const asc = !sortState[col];
  sortState = { [col]: asc };

  currentData.sort((a,b) => {
    const x=a[col], y=b[col];
    const nx=parseFloat(x), ny=parseFloat(y);
    if(!isNaN(nx)&&!isNaN(ny)) return asc?nx-ny:ny-nx;
    return asc?String(x).localeCompare(y):String(y).localeCompare(x);
  });

  renderTable(currentData);
}

/* ---------- Load ---------- */
fetch(CSV_FILE)
  .then(r => r.text())
  .then(t => {
    rawData = parseCSV(t);
    activateTopTab("Folio");   // default behavior preserved
  });
</script>

</body>
</html>
