<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Portfolio Technical Report</title>

<style>
body {
  margin: 0;
  font-family: "Courier New", monospace;
  font-size: 13px;
}

.topbar {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  background: #1e1e1e;
  color: white;
  padding: 8px;
}

.tab {
  padding: 6px 12px;
  cursor: pointer;
  background: #333;
  border-radius: 4px;
}

.tab.active {
  background: #007acc;
}

.content {
  height: calc(100vh - 52px);
  overflow: auto;
  padding: 8px;
}

table {
  border-collapse: collapse;
  width: max-content;
}

th, td {
  border: 1px solid #ccc;
  padding: 6px;
}

th {
  background: #f0f0f0;
  position: sticky;
  top: 0;
  z-index: 5;
}

th.symbol-col,
td.symbol-col {
  position: sticky;
  left: 0;
  background: #fafafa;
  z-index: 6;
  font-weight: bold;
}

tbody tr:nth-child(even) td {
  background: #f9f9f9;
}

td.text { text-align: left; }
td.num { text-align: right; }

.green { background: #c8f7c5 !important; }
.red { background: #f7c5c5 !important; }

.filter {
  width: 90%;
  margin-top: 4px;
  font-size: 11px;
}
</style>
</head>

<body>

<div class="topbar" id="topTabs"></div>

<div class="content">
  <table id="dataTable"></table>
</div>

<script>
const CSV_FILE = "portfolio_report.csv";

let rawData = [];
let currentView = [];
let activeTabData = [];

/* ---------- CSV ---------- */
function parseCSV(text) {
  const lines = text.trim().split("\n");
  const headers = lines[0].split(",");
  return lines.slice(1).map(r => {
    const v = r.split(",");
    let o = {};
    headers.forEach((h, i) => o[h] = v[i] ?? "");
    return o;
  });
}

/* ---------- Tabs ---------- */
function buildTabs() {
  const bar = document.getElementById("topTabs");
  bar.innerHTML = "";

  addTab("EXIT", () => {
    activeTabData = rawData.filter(
      d => d.StopLoss && parseFloat(d.Close) < parseFloat(d.StopLoss)
    );
    renderTable(activeTabData);
  });

  addTab("Portfolio", () => {
    activeTabData = [...rawData];
    renderTable(activeTabData);
  });

  [...new Set(rawData.map(d => d.Folio).filter(Boolean))].sort()
    .forEach(folio =>
      addTab(folio, () => {
        activeTabData = rawData.filter(d => d.Folio === folio);
        renderTable(activeTabData);
      })
    );
}

function addTab(label, action) {
  const div = document.createElement("div");
  div.className = "tab";
  div.innerText = label;
  div.onclick = () => {
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    div.classList.add("active");
    action();
  };
  document.getElementById("topTabs").appendChild(div);
}

/* ---------- Table ---------- */
function renderTable(data) {
  currentView = [...data];
  const table = document.getElementById("dataTable");
  table.innerHTML = "";
  if (!data.length) return;

  const headers = Object.keys(data[0]);
  renderHeader(headers);
  renderRows(data, headers);
}

function renderHeader(headers) {
  const table = document.getElementById("dataTable");
  const tr = document.createElement("tr");

  headers.forEach(h => {
    const th = document.createElement("th");
    th.innerHTML = `<div>${h}</div>`;
    if (h === "Symbol") th.classList.add("symbol-col");

    /* String filters */
    if (["Folio","MarketCap","Sector","Notes"].includes(h)) {
      th.innerHTML += `<input class="filter" oninput="applyFilters()">`;
    }

    /* Numeric filters */
    if (/MACD|RSI|DD_High/.test(h)) {
      th.innerHTML += `
        <select class="filter" onchange="applyFilters()">
          <option value=""></option>
          <option value=">">></option>
          <option value="<"><</option>
          <option value="between">between</option>
        </select>
        <input class="filter" placeholder="value" oninput="applyFilters()">
        <input class="filter" placeholder="and" oninput="applyFilters()">
      `;
    }

    tr.appendChild(th);
  });

  table.appendChild(tr);
}

function renderRows(data, headers) {
  const table = document.getElementById("dataTable");
  data.forEach(r => {
    const tr = document.createElement("tr");
    headers.forEach(h => {
      const td = document.createElement("td");
      const v = r[h];

      if (h === "Symbol") {
        td.className = "symbol-col text";
        td.innerHTML = `<a href="#" onclick="openChart('${v}')">${v}</a>`;
      } else {
        td.innerText = v;
        td.className = (!isNaN(v) && v !== "") ? "num" : "text";
      }

      if (h.includes("MACD") && v !== "")
        td.classList.add(parseFloat(v) >= 0 ? "green" : "red");
      if (h.includes("RSI") && v !== "")
        td.classList.add(parseFloat(v) >= 53 ? "green" : "red");

      tr.appendChild(td);
    });
    table.appendChild(tr);
  });
}

/* ---------- Filters ---------- */
function applyFilters() {
  const table = document.getElementById("dataTable");
  const headerCells = table.rows[0].cells;
  let filtered = activeTabData.filter(row => {
    for (let i = 0; i < headerCells.length; i++) {
      const h = table.rows[0].cells[i].innerText.split("\n")[0];
      const inputs = headerCells[i].querySelectorAll("input,select");
      if (!inputs.length) continue;

      const val = row[h];
      if (/MACD|RSI|DD_High/.test(h)) {
        const op = inputs[0].value;
        const v1 = parseFloat(inputs[1].value);
        const v2 = parseFloat(inputs[2].value);
        const num = parseFloat(val);
        if (op === ">" && !(num > v1)) return false;
        if (op === "<" && !(num < v1)) return false;
        if (op === "between" && !(num >= v1 && num <= v2)) return false;
      } else {
        const txt = inputs[0].value.toLowerCase();
        if (txt && !String(val).toLowerCase().includes(txt)) return false;
      }
    }
    return true;
  });

  renderTable(filtered);
}

/* ---------- TradingView ---------- */
function openChart(symbol) {
  const url = `https://in.tradingview.com/chart/?symbol=NSE:${symbol}`;
  window.open(url, "_blank", "width=1300,height=900");
}

/* ---------- Load ---------- */
fetch(CSV_FILE)
  .then(r => r.text())
  .then(t => {
    rawData = parseCSV(t);
    buildTabs();
    document.querySelector(".tab").click();
  });
</script>

</body>
</html>
