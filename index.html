<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Portfolio Technical Report</title>

<!-- TradingView Widget -->
<script src="https://s3.tradingview.com/tv.js"></script>

<style>
body {
  margin: 0;
  font-family: "Courier New", monospace;
  font-size: 13px;
}

/* ---------- Top Tabs ---------- */
.topbar {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  background: #1e1e1e;
  color: white;
  padding: 8px;
}

.tab {
  padding: 6px 12px;
  cursor: pointer;
  background: #333;
  border-radius: 4px;
  white-space: nowrap;
}

.tab.active {
  background: #007acc;
}

/* ---------- Content ---------- */
.content {
  height: calc(100vh - 52px);
  overflow: auto;
  padding: 8px;
}

/* ---------- Table ---------- */
table {
  border-collapse: collapse;
  font-size: 13px;
}

th, td {
  border: 1px solid #ccc;
  padding: 6px 8px;
  background: white;
}

th {
  background: #f0f0f0;
  position: sticky;
  top: 0;
  cursor: pointer;
  z-index: 5;
}

/* Sticky Symbol column */
th.symbol-col,
td.symbol-col {
  position: sticky;
  left: 0;
  background: #fafafa;
  z-index: 6;
  font-weight: bold;
}

/* Zebra striping */
tbody tr:nth-child(even) td {
  background: #f9f9f9;
}

/* Group header */
.group-header td {
  background: #ddd !important;
  font-weight: bold;
  text-align: left;
}

/* Alignment */
td.text { text-align: left; }
td.num  { text-align: right; }

.green { background: #c8f7c5 !important; }
.red   { background: #f7c5c5 !important; }

/* ---------- Modal ---------- */
.modal {
  display: none;
  position: fixed;
  z-index: 999;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.75);
}

.modal-content {
  position: relative;
  background: #fff;
  width: 94%;
  height: 94%;
  margin: 2% auto;
  border-radius: 6px;
  overflow: hidden;
}

.modal-header {
  padding: 6px 10px;
  background: #1e1e1e;
  color: white;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-header span {
  cursor: pointer;
  font-size: 16px;
}

#tv_chart {
  width: 100%;
  height: calc(100% - 34px);
}
</style>
</head>

<body>

<div class="topbar" id="topTabs"></div>

<div class="content">
  <table id="dataTable"></table>
</div>

<!-- ---------- TradingView Modal ---------- -->
<div id="tvModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <div id="tvTitle"></div>
      <span onclick="closeModal()">✖</span>
    </div>
    <div id="tv_chart"></div>
  </div>
</div>

<script>
const CSV_FILE = "portfolio_report.csv";
let rawData = [];
let currentData = [];
let sortState = {};
let tvWidget = null;

/* ---------- CSV ---------- */
function parseCSV(text) {
  const lines = text.trim().split("\n");
  const headers = lines[0].split(",");
  return lines.slice(1).map(r => {
    const v = r.split(",");
    let o = {};
    headers.forEach((h, i) => o[h] = v[i] ?? "");
    return o;
  });
}

/* ---------- Tabs ---------- */
function buildTopTabs() {
  const bar = document.getElementById("topTabs");
  bar.innerHTML = "";

  addTab("EXIT", () =>
    renderTable(rawData.filter(d =>
      d.StopLoss && parseFloat(d.Close) < parseFloat(d.StopLoss)
    ))
  );

  [...new Set(rawData.map(d => d.Folio).filter(Boolean))].sort()
    .forEach(f => addTab(f, () =>
      renderTable(rawData.filter(d => d.Folio === f))
    ));

  addTab("SectorWise", () => renderGrouped("Sector"));
  addTab("MarketCapWise", () => renderGrouped("MarketCap"));
}

function addTab(label, action) {
  const div = document.createElement("div");
  div.className = "tab";
  div.innerText = label;
  div.onclick = () => {
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    div.classList.add("active");
    action();
  };
  document.getElementById("topTabs").appendChild(div);
}

/* ---------- Grouped Views ---------- */
function renderGrouped(field) {
  const table = document.getElementById("dataTable");
  table.innerHTML = "";

  const groups = {};
  rawData.forEach(r => {
    const key = r[field] || "Others";
    groups[key] = groups[key] || [];
    groups[key].push(r);
  });

  const headers = Object.keys(rawData[0]);
  renderHeader(headers);

  Object.keys(groups).sort().forEach(group => {
    const tr = document.createElement("tr");
    tr.className = "group-header";
    const td = document.createElement("td");
    td.colSpan = headers.length;
    td.innerText = `${field}: ${group}`;
    tr.appendChild(td);
    table.appendChild(tr);

    renderRows(groups[group], headers);
  });
}

/* ---------- Table ---------- */
function renderHeader(headers) {
  const table = document.getElementById("dataTable");
  const tr = document.createElement("tr");

  headers.forEach(h => {
    const th = document.createElement("th");
    th.innerText = h;
    th.onclick = () => sortBy(h);
    if (h === "Symbol") th.classList.add("symbol-col");
    tr.appendChild(th);
  });

  table.appendChild(tr);
}

function renderTable(data) {
  currentData = [...data];
  const table = document.getElementById("dataTable");
  table.innerHTML = "";
  if (!data.length) return;

  const headers = Object.keys(data[0]);
  renderHeader(headers);
  renderRows(data, headers);
}

function renderRows(data, headers) {
  const table = document.getElementById("dataTable");
  data.forEach(r => {
    const tr = document.createElement("tr");
    headers.forEach(h => {
      const td = document.createElement("td");
      const v = r[h];

      if (h === "Symbol") {
        td.classList.add("symbol-col", "text");
        td.innerHTML = `<a href="#" onclick="openChart('${v}')">${v}</a>`;
      } else {
        td.innerText = v;
        td.className = (!isNaN(v) && v !== "") ? "num" : "text";
      }

      if (h.includes("MACD") && v !== "")
        td.classList.add(parseFloat(v) >= 0 ? "green" : "red");
      if (h.includes("RSI") && v !== "")
        td.classList.add(parseFloat(v) >= 53 ? "green" : "red");

      tr.appendChild(td);
    });
    table.appendChild(tr);
  });
}

/* ---------- Sorting ---------- */
function sortBy(col) {
  const asc = !sortState[col];
  sortState = { [col]: asc };

  currentData.sort((a,b) => {
    const x=a[col], y=b[col];
    const nx=parseFloat(x), ny=parseFloat(y);
    if(!isNaN(nx)&&!isNaN(ny)) return asc?nx-ny:ny-nx;
    return asc?String(x).localeCompare(y):String(y).localeCompare(x);
  });

  renderTable(currentData);
}

/* ---------- TradingView Widget (with MACD) ---------- */
function openChart(symbol) {
  document.getElementById("tvModal").style.display = "block";
  document.getElementById("tvTitle").innerText = symbol + " - TradingView";

  document.getElementById("tv_chart").innerHTML = "";

  tvWidget = new TradingView.widget({
    autosize: true,
    symbol: "NSE:" + symbol + "-EQ",
    interval: "D",
    timezone: "Asia/Kolkata",
    theme: "light",
    style: "1",
    locale: "in",
    toolbar_bg: "#f1f3f6",
    hide_top_toolbar: false,
    hide_side_toolbar: false,
    allow_symbol_change: false,
    studies: [
      "MACD@tv-basicstudies"   // ✅ MACD added
    ],
    container_id: "tv_chart"
  });
}

function closeModal() {
  document.getElementById("tvModal").style.display = "none";
  document.getElementById("tv_chart").innerHTML = "";
  tvWidget = null;
}

/* ---------- Load ---------- */
fetch(CSV_FILE)
  .then(r => r.text())
  .then(t => {
    rawData = parseCSV(t);
    buildTopTabs();
    document.querySelector(".tab").click(); // default EXIT
  });
</script>

</body>
</html>
