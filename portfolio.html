<!-- ===================== PORTFOLIO FEATURE ===================== -->

<style>
/* ---------- Update Time ---------- */
.update-time {
  position: fixed;
  top: 40px;
  right: 10px;
  font-size: 11px;
  color: #bbb;
  z-index: 999;
}

/* ---------- Content ---------- */
.content {
  height: calc(100vh - 60px);
  overflow: auto;
  padding: 8px;
}

/* ---------- Table ---------- */
table {
  border-collapse: collapse;
  width: max-content;
  font-size: 13px;
}

th, td {
  border: 1px solid #ccc;
  padding: 6px 8px;
  background: white;
}

th {
  background: #f0f0f0;
  position: sticky;
  top: 0;
  cursor: pointer;
  z-index: 5;
}

th.symbol-col,
td.symbol-col {
  position: sticky;
  left: 0;
  background: #fafafa;
  z-index: 6;
  font-weight: bold;
}

tbody tr:nth-child(even) td {
  background: #f9f9f9;
}

td.text { text-align: left; }
td.num  { text-align: right; }

.green { background: #c8f7c5 !important; }
.red   { background: #f7c5c5 !important; }
</style>

<div class="update-time" id="updateTime"></div>

<div class="content">
  <table id="dataTable"></table>
</div>

<script>
const CSV_FILE = "portfolio_report.csv";

const COLUMN_ORDER = [
  "Symbol","Folio",
  "IC","CC","PnL","DD_High",
  "LT_days","LT_Pert",
  "4H_MACD","D_MACD",
  "W_MACD","M_MACD",
  "W_RSI","M_RSI",
  "AvgPrice","StopLoss","CurPrice",
  "Sector","MarketCap","Notes"
];

let rawData = [];
let currentData = [];
let sortState = {};

/* ---------- Helpers ---------- */
function parseCSV(text) {
  const lines = text.trim().split("\n");
  const headers = lines[0].split(",");
  return lines.slice(1).map(r => {
    const v = r.split(",");
    let o = {};
    headers.forEach((h, i) => o[h] = v[i] ?? "");
    return o;
  });
}

function folioPriority(name) {
  if (name.startsWith("Trade")) return 1;
  if (name.startsWith("Sate"))  return 2;
  if (name.startsWith("Core"))  return 3;
  return 4;
}

/* ---------- Register Portfolio Tabs ---------- */
window.registerTabs(function (addTab) {

  fetch(CSV_FILE)
    .then(r => r.text())
    .then(t => {
      rawData = parseCSV(t);

      const folios =
        [...new Set(rawData.map(d => d.Folio).filter(Boolean))]
          .sort((a, b) => {
            const pa = folioPriority(a);
            const pb = folioPriority(b);
            return pa !== pb ? pa - pb : a.localeCompare(b);
          });

      /* Folio tabs */
      folios.forEach(folio => {
        addTab(folio, () => {
          renderAndDefaultSort(
            rawData.filter(d => d.Folio === folio)
          );
        });
      });

      /* EXIT tab */
      addTab("EXIT", () => {
        renderAndDefaultSort(
          rawData.filter(d =>
            d.StopLoss &&
            !isNaN(parseFloat(d.CurPrice)) &&
            parseFloat(d.CurPrice) < parseFloat(d.StopLoss)
          )
        );
      });

      updateLastRunTime();
    });
});

/* ---------- Table ---------- */
function renderAndDefaultSort(data) {
  currentData = [...data];
  sortState = {};
  defaultSortByDMACD();
  renderTable(currentData);
}

function renderTable(data) {
  const table = document.getElementById("dataTable");
  table.innerHTML = "";
  if (!data.length) return;

  const tr = document.createElement("tr");
  COLUMN_ORDER.forEach(h => {
    if (!(h in data[0])) return;
    const th = document.createElement("th");
    th.innerText = h;
    th.onclick = () => sortBy(h);
    if (h === "Symbol") th.classList.add("symbol-col");
    tr.appendChild(th);
  });
  table.appendChild(tr);

  data.forEach(r => {
    const row = document.createElement("tr");
    COLUMN_ORDER.forEach(h => {
      if (!(h in r)) return;
      const td = document.createElement("td");
      const v = r[h];

      if (h === "Symbol") {
        td.className = "symbol-col text";
        td.innerHTML =
          `<a href="#" onclick="openChart('${v}')">${v}</a>`;
      } else {
        td.innerText = v;
        td.className = (!isNaN(v) && v !== "") ? "num" : "text";
      }

      if (h === "DD_High" && parseFloat(v) < -18)
        td.classList.add("red");

      if (h.includes("MACD") && v !== "")
        td.classList.add(parseFloat(v) >= 0 ? "green" : "red");

      if (h.includes("RSI") && v !== "")
        td.classList.add(parseFloat(v) >= 53 ? "green" : "red");

      row.appendChild(td);
    });
    table.appendChild(row);
  });
}

/* ---------- Sorting ---------- */
function defaultSortByDMACD() {
  currentData.sort((a, b) => parseFloat(a.D_MACD) - parseFloat(b.D_MACD));
}

function sortBy(col) {
  const asc = !sortState[col];
  sortState = { [col]: asc };
  currentData.sort((a, b) => {
    const x = parseFloat(a[col]), y = parseFloat(b[col]);
    if (!isNaN(x) && !isNaN(y)) return asc ? x - y : y - x;
    return asc
      ? String(a[col]).localeCompare(b[col])
      : String(b[col]).localeCompare(a[col]);
  });
  renderTable(currentData);
}

/* ---------- TradingView ---------- */
function openChart(symbol) {
  window.open(
    `https://in.tradingview.com/chart/?symbol=NSE:${encodeURIComponent(symbol)}`,
    "_blank"
  );
}

/* ---------- Update Time ---------- */
function updateLastRunTime() {
  fetch(CSV_FILE, { method: "HEAD" })
    .then(res => {
      const lm = res.headers.get("Last-Modified");
      if (!lm) return;
      const d = new Date(lm);
      document.getElementById("updateTime").innerText =
        d.toLocaleTimeString("en-IN",{timeZone:"Asia/Kolkata",hour:"2-digit",minute:"2-digit",hour12:false})
        + " / " +
        d.toLocaleDateString("en-IN",{timeZone:"Asia/Kolkata",year:"numeric",month:"short",day:"2-digit"});
    });
}
</script>
